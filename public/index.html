<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Video Conference</title>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client/dist/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-peer/simplepeer.min.js"></script>
</head>

<body>
  <video id="local-video" autoplay></video>
  <div id="remote-videos"></div>

  <script>
    const socket = io('/');
    const peers = {};

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then((stream) => {
        const localVideo = document.getElementById('local-video');
        localVideo.srcObject = stream;

        socket.on('user-connected', (userId) => {
          connectToNewUser(userId, stream);
        });
      });

    socket.on('user-disconnected', (userId) => {
      if (peers[userId]) peers[userId].close();
    });

    const configuration = {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' }, // Google's public STUN server
            ],
       };
    function connectToNewUser(userId, stream) {
      const peer = new SimplePeer({
        initiator: true,
        trickle: false,
        stream,
        config: configuration,
      });

      peer.on('signal', (data) => {
        socket.emit('join-room', ROOM_ID, { userId, signalData: data });
      });

      socket.on('user-connected', (user) => {
        if (user.userId === userId) {
          peer.signal(user.signalData);
        }
      });

      peer.on('stream', (remoteStream) => {
        const remoteVideo = document.createElement('video');
        remoteVideo.srcObject = remoteStream;
        remoteVideo.autoplay = true;
        document.getElementById('remote-videos').appendChild(remoteVideo);
      });

      peer.on('close', () => {
        remoteVideo.remove();
      });

      peers[userId] = peer;
    }
    function connectToNewUser(userId, stream) {
  const peer = new SimplePeer({
    initiator: true,
    trickle: false,
    stream,
    config: configuration,
  });

  peer.on('signal', (data) => {
    socket.emit('join-room', ROOM_ID, { userId, signalData: data });
  });

  socket.on('user-connected', (user) => {
    if (user.userId === userId && !peers[userId]) {
      const remoteVideo = document.createElement('video');
      document.getElementById('remote-videos').appendChild(remoteVideo);

      const newPeer = new SimplePeer({
        initiator: false,
        trickle: false,
        stream,
        config: configuration,
      });

      newPeer.on('signal', (signalData) => {
        socket.emit('join-room', ROOM_ID, { userId, signalData });
      });

      newPeer.on('stream', (remoteStream) => {
        remoteVideo.srcObject = remoteStream;
        remoteVideo.autoplay = true;
      });

      newPeer.signal(user.signalData);
      peers[userId] = newPeer;
    }
  });

  peer.on('close', () => {
    if (peers[userId]) {
      peers[userId].destroy();
      delete peers[userId];
    }
  });
}

  </script>
</body>

</html>
